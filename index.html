<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>DNS Check → Redirect</title>
<style>
  body{font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial;margin:0;text-align:center;padding:12vh 16px}
  .spinner{width:36px;height:36px;border:4px solid #eee;border-top-color:#555;border-radius:50%;margin:16px auto;animation:spin 1s linear infinite}
  @keyframes spin{to{transform:rotate(360deg)}}
  #msg{color:#666}
</style>
</head>
<body>
  <h2>Checking your DNS…</h2>
  <div class="spinner"></div>
  <p id="msg">Please wait, redirecting to the form.</p>

<script>
(async () => {
  const qs = new URLSearchParams(location.search);
  const setMsg = t => { const el=document.getElementById('msg'); if (el) el.textContent=t; };
  const canon = s => String(s||'').trim().replace(/\.$/,'').toLowerCase();

  // Required inputs
  const jotformEnc = (qs.get('jotform') || '').trim();           // FULL JotForm URL (encoded once)
  const domain     = (qs.get('domain') || '').trim();
  const expectedA  = (qs.get('expectedA') || '').split(',').map(s=>s.trim()).filter(Boolean);
  const expectedC  = (qs.get('expectedC') || '').trim();
  const cnameHost  = (qs.get('cnameHost') || 'www').trim() || 'www';
  const cacheBust  = qs.get('cacheBust') === '1';                 // optional

  if (!jotformEnc) { setMsg('Missing ?jotform='); return; }
  if (!domain || (!expectedA.length && !expectedC)) { setMsg('Missing DNS params'); return; }

  // DNS-over-HTTPS (Cloudflare → Google fallback)
  async function doh(name, type) {
    const urls = [
      `https://cloudflare-dns.com/dns-query?ct=application/dns-json&name=${encodeURIComponent(name)}&type=${encodeURIComponent(type)}`,
      `https://dns.google/resolve?name=${encodeURIComponent(name)}&type=${encodeURIComponent(type)}`
    ];
    let lastErr;
    for (const url of urls) {
      try {
        const headers = url.includes('cloudflare-dns.com') ? { accept:'application/dns-json' } : {};
        const r = await fetch(url, { mode:'cors', headers, cache:'no-store' });
        if (!r.ok) throw new Error(`HTTP ${r.status}`);
        const j = await r.json();
        return (j.Answer || []).map(a => a.data);
      } catch (e) { lastErr = e; }
    }
    throw lastErr || new Error('All DoH providers failed');
  }

  // Compute dnsvalid
  let dnsOK = false;
  try {
    const liveA = (await doh(domain, 'A')).filter(v => /^\d+\.\d+\.\d+\.\d+$/.test(v));
    const fqdn  = (cnameHost === '@' ? domain : `${cnameHost}.${domain}`);
    let liveC   = (await doh(fqdn, 'CNAME')).map(canon);

    const aMatch = expectedA.length ? expectedA.every(ip => liveA.includes(ip)) : null;
    let   cMatch = expectedC ? liveC.includes(canon(expectedC)) : null;

    // tolerate flattened CNAME (A(host) == A(expectedC))
    if (expectedC && cMatch === false && liveC.length === 0) {
      const hostA      = (await doh(fqdn, 'A')).filter(v => /^\d+\.\d+\.\d+\.\d+$/.test(v));
      const expectedCA = (await doh(expectedC, 'A')).filter(v => /^\d+\.\d+\.\d+\.\d+$/.test(v));
      if (hostA.length && expectedCA.length && expectedCA.every(ip => hostA.includes(ip))) cMatch = true;
    }

    const checks = [aMatch, cMatch].filter(v => v !== null);
    dnsOK = checks.length ? checks.every(Boolean) : false;
  } catch (e) {
    dnsOK = false;
  }

  // Decode JotForm URL (encoded once)
  let jotform;
  try { jotform = decodeURIComponent(jotformEnc); } catch { jotform = jotformEnc; }
  let target;
  try { target = new URL(jotform); } catch { setMsg('Invalid JotForm URL'); return; }

  // Append dnsvalid
  target.searchParams.set('dnsvalid', dnsOK ? 'yes' : 'no');

  // Build the checker URL using URL + searchParams (prevents glue issues)
  const checkerUrl = new URL('https://websmartzadmin.github.io/dnschecker');
  checkerUrl.searchParams.set('domain', domain);
  if (expectedA.length) checkerUrl.searchParams.set('expectedA', expectedA.join(','));
  if (expectedC)        checkerUrl.searchParams.set('expectedC', expectedC);
  checkerUrl.searchParams.set('cnameHost', cnameHost);

  // Optional cache-buster for iOS Safari
  if (cacheBust) {
    const cb = target.searchParams.get('rowid') || target.searchParams.get('cb') || String(Date.now());
    checkerUrl.searchParams.set('cb', cb);
  }

  // Hand BOTH versions back to JotForm:
  // 1) Encoded (safe for URL bar) – the browser will encode this in the final URL
  target.searchParams.set('dnscheckurl', checkerUrl.toString());
  // 2) Raw (plain) – your widget should prefer this if present (especially on iOS)
  target.searchParams.set('dnscheckurl_raw', checkerUrl.toString());

  setMsg(dnsOK ? 'DNS valid — redirecting…' : 'DNS not valid — redirecting…');
  location.replace(target.toString());
})();
</script>
</body>
</html>



